class Reader{constructor(e){e.container&&0!=e.container.length?(this.gui=e.container,this.gui.data("reader",this),e.images_dir?(this.images_dir=e.images_dir,e.comicsJson&&"object"==typeof e.comicsJson?(this.comic=e.comicsJson,this.known_panels=e.known_panels?e.known_panels:[],this.currpage=0,this.currpanel=0,this.debug=this.gui.hasClass("debug")||"debug"in this.getHashInfo(),this.debug&&this.gui.addClass("debug"),this.container=$('<div class="container"/>'),this.container.css({position:"relative",width:"95%",height:"95%",margin:"auto"}),this.gui.append(this.container),window.addEventListener("orientationchange",function(){setTimeout(function(){this.gotoPanel(this.currpanel)}.bind(this),500)}.bind(this)),this.init_keyboard_navigation()):console.error("no comicsJson given in options, or not a javascript object")):console.error("no images_dir given in options")):console.error("no container given in options")}getHashInfo(){var e=window.location.hash.replace(/^#/,"").split(","),t={};for(var i in e){var n=e[i].split("=");t[n[0]]=n[1]}return t}setHashInfo(e){var t=this.getHashInfo();for(var i in e)t[i]=e[i];t=Object.entries(t).map(function(e){return null===e[1]?"":e[0]+(e[1]?"="+e[1]:"")}).filter(function(e){return!!e}),window.location.hash=t.join(",")}start(){var e=this.getHashInfo().pagie;e||(e=0),this.loadPage(e)}next(){this.container.is(".zoomed")?this.nextPanel():this.loadNextPage()}prev(){this.container.is(".zoomed")?this.prevPanel():this.loadPrevPage()}loadNextPage(){return this.loadPage(this.currpage+1)}loadPrevPage(){return this.loadPage(this.currpage-1)}loadPage(e=0){if((e=parseInt(e))<0||e>=this.comic.length)return!1;this.currpage=e,this.setHashInfo({page:e||null}),$(".pagenb",this.gui).html("page "+(e+1)+" <small>/"+this.comic.length+"</small>");var t=this.comic[e],i=400/(t.size[0]/t.size[1]);t.height=i,t.width=400,this.gui.hasClass("fullpage")||this.gui.css({width:400,height:i,padding:"2em"});var n="urls"==this.images_dir?t.filename:this.images_dir+t.filename.split("/").reverse()[0],a=$('<img class="pageimg" src="'+n+'"/>');a.css({position:"absolute",width:"100%",height:"100%"}),this.container.children("img").remove(),this.container.prepend(a);var s=this.get_license(t);s?(this.gui.append('<span class="license"/>'),this.gui.children(".license").html(s)):$(".license",this.gui).remove();this.container.is(".zoomed");return this.drawPanels(t),this.dezoom(),t.panels&&Object.keys(t.panels).length>0?("last"==this.currpanel?this.currpanel=$(".panel").length-1:this.currpanel=0,this.gotoPanel(this.currpanel)):this.currpanel=0,!0}zoomOn(e){var t=this.container.parent().width()/e.width(),i="x",n=this.container.parent().height()/e.height();n<t&&(t=n,i="y");var a={top:-e.position().top*t,left:-e.position().left*t,height:this.container.height()*t,width:this.container.width()*t};"x"==i?a.top+=(this.container.parent().height()-e.height()*t)/2:a.left+=(this.container.parent().width()-e.width()*t)/2,$(".panel.zoomTarget").removeClass("zoomTarget"),e.addClass("zoomTarget"),e[0].style.background="transparent",this.container.addClass("zoomed"),this.container.animate(a,300)}dezoom(){var e=this.getImgSize(),t={width:e.w,height:e.h,left:0,top:0};this.container.removeClass("zoomed"),this.container.css(t)}getImgSize(){var e={w:this.container.parent().width(),h:this.container.parent().height()},t=this.comic[this.currpage].size,i=t[0]/t[1];return e.w>e.h*i?e.w=e.h*i:e.h>e.w/i&&(e.h=e.w/i),e}gotoPanel(e){if(0==e){let e=document.getElementsByClassName("panel");for(let t=0;t<e.length;t++)e[t].style.background="white"}if(e<0)return this.currpanel="last",void(this.loadPrevPage()||(this.currpanel=0));var t=$(".panel").eq(e);t.length>0?this.zoomOn(t):this.loadNextPage()||this.currpanel--}nextPanel(){this.currpanel++,this.gotoPanel(this.currpanel)}prevPanel(){this.currpanel--,this.gotoPanel(this.currpanel)}drawPanels(e){this.container.children("*:not(.pageimg)").remove();var[t,i]=e.size,n=1;for(var a in e.panels){var s=!this.known_panels.includes(parseInt(a)),o=e.panels[a],[r,h,l,c]=[o.x,o.y,o.width,o.height],p=$('<div class="panel">\x3c!-- --\x3e</div>');s&&p.addClass("unknown");var d={top:h/i*100+"%",left:r/t*100+"%",height:c/i*100+"%",width:l/t*100+"%"};p.css(d),p.append('<span class="panelnb">'+n+++"</span>"),p.append('<span class="top">'+h),p.append('<span class="bottom">'+(h+c)),p.append('<span class="left">'+r),p.append('<span class="right">'+(r+l)),this.container.append(p)}}add_controls(){var e=this;this.gui.append('<span class="pagenb"/>');var t=$('<i class="burger">☰</i>');t.data("reader",this),t.on("click touch",function(e){$(this).data("reader").showMenu()}),this.gui.append(t);var i=$('<i class="prev">←</i>');i.data("reader",this),i.on("click touch",function(e){$(this).data("reader").prev()}),this.gui.append(i);var n=$('<div class="menu"/>'),a=$("<ul/>");a.append('<li><label><input type="radio" name="viewmode" value="panel" autocomplete="off" />Panel</label></li>'),n.append(a),this.debug&&btn_debug.children(".toggleDebug").prop("checked",!0),btn_debug.children(".toggleDebug").on("change",function(){e.gui.toggleClass("debug"),e.setHashInfo({debug:e.gui.hasClass("debug")?"":null})}),a.append(btn_debug),a.append('<i class="exit">X</i>'),a.children(".exit").on("click touch",function(){e.showMenu(!1)}),a.append(' \t\t\t<li>---</li> \t\t\t<li class="kbd"><span>click/tap</span><span>next page/panel</span></li> \t\t\t<li class="kbd"><span>right/down</span><span>next page/panel</span></li> \t\t\t<li class="kbd"><span>left/up</span><span>previous page/panel</span></li> \t\t\t<li class="kbd"><span>p</span><span>switch page/panel view</span></li> \t\t\t<li class="kbd"><span>m</span><span>show this menu</span></li> \t\t\t<li class="kbd"><span>d</span><span>debug (show panels)</span></li> \t\t'),this.gui.append(n),this.showMenu(!1),$(document).ready(function(){$("input[name=viewmode][value=panel]",e.gui).prop("checked",!0).change()})}get_license(e){if(!e.license)return"";for(var t=[],i=0;i<3;i++){var n=["title","author","license"][i];if(n in e.license){var a=e.license;t.push({title:"",author:"by ",license:""}[n]+(a[n+"_link"]?'<a target="_blank" href="'+a[n+"_link"]+'">'+a[n]+"</a>":a[n]))}}return t.join(", ")}showMenu(e=!0){var t=this.gui.children(".menu");"toggle"==e&&(e=!t.is(":visible")),e?t.show():t.hide()}init_keyboard_navigation(){$(document).keydown(e=>{if(!e.altKey){switch(e.which){case 37:case 38:this.prev();break;case 39:case 40:this.next();break;case 77:this.showMenu("toggle");break;case 80:$("input[name=viewmode]:not(:checked)").prop("checked",!0).change();break;default:return}e.preventDefault()}})}}$(document).delegate("input[name=viewmode]","change",function(){if($(this).is(":checked")){var e=$(this).parents(".kumiko-reader:eq(0)").data("reader");if("panel"===$(this).val())e.gotoPanel(0);e.container.css({}),e.container.focus()}}),$(document).delegate(".kumiko-reader","click touch",function(e){$(e.target).is(".panel,.kumiko-reader")&&$(this).data("reader").next()}),$(document).delegate(".license a","click touch",function(e){e.stopPropagation()});
